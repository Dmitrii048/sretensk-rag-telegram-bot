import asyncio
import os
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.enums import ParseMode

# –ò–º–ø–æ—Ä—Ç—ã RAG
from langchain_community.vectorstores import FAISS
from langchain_huggingface import HuggingFaceEmbeddings, HuggingFaceEndpoint, ChatHuggingFace

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
# –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å –∏—Ö —Å—é–¥–∞ –∂–µ—Å—Ç–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∞ (–Ω–æ –ª—É—á—à–µ —á–µ—Ä–µ–∑ env)
BOT_TOKEN = os.getenv("BOT_TOKEN")
HF_TOKEN = os.getenv("HF_TOKEN")
DB_PATH = "sretensk_db" # –ü–∞–ø–∫–∞ —Å –±–∞–∑–æ–π, –∫–æ—Ç–æ—Ä—É—é –º—ã —Å–æ–∑–¥–∞–ª–∏ create_db_advanced.py

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
if not BOT_TOKEN or not HF_TOKEN:
    print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ç–æ–∫–µ–Ω—ã (BOT_TOKEN –∏–ª–∏ HF_TOKEN).")
    exit(1)

# === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø AI ===
print("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –°—Ä–µ—Ç–µ–Ω—Å–∫–æ–π –ê–∫–∞–¥–µ–º–∏–∏...")
try:
    # 1. –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ (—Ç–µ –∂–µ, —á—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã!)
    embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")
    
    # 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    db = FAISS.load_local(DB_PATH, embeddings, allow_dangerous_deserialization=True)
    
    # 3. –ú–æ–∑–≥ (Qwen 7B –∏–ª–∏ 72B - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–≤–æ–µ–≥–æ –≤—ã–±–æ—Ä–∞ –≤ create_db)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º 7B –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏, –Ω–æ Instruct –≤–µ—Ä—Å–∏—é
    endpoint = HuggingFaceEndpoint(
        repo_id="Qwen/Qwen2.5-7B-Instruct", 
        huggingfacehub_api_token=HF_TOKEN,
        temperature=0.3, # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–∞–∫—Ç–æ–≤
        max_new_tokens=1500,
    )
    llm = ChatHuggingFace(llm=endpoint)
    print("‚úÖ AI —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!")
except Exception as e:
    print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê AI: {e}")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ sretensk_db —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–∑–¥–∞–Ω–∞ —Å–∫—Ä–∏–ø—Ç–æ–º create_db_advanced.py")
    exit(1)

# === –ë–û–¢ ===
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# === –ö–õ–ê–í–ò–ê–¢–£–†–ê (–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ) ===
# –£–±—Ä–∞–ª–∏ WebApp, —Å–¥–µ–ª–∞–ª–∏ —É–¥–æ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å —á–∞—Å—Ç—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
kb_main = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üéì –ü—Ä–∞–≤–∏–ª–∞ –æ—Ç—á–∏—Å–ª–µ–Ω–∏—è"), KeyboardButton(text="üí∞ –°—Ç–∏–ø–µ–Ω–¥–∏–∏")],
        [KeyboardButton(text="üìÖ –°–µ—Å—Å–∏—è –∏ –ø–µ—Ä–µ—Å–¥–∞—á–∏"), KeyboardButton(text="üè† –û–±—â–µ–∂–∏—Ç–∏–µ")],
        [KeyboardButton(text="‚ùì –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∞–∫–∞–¥–µ–º?")]
    ],
    resize_keyboard=True,
    input_field_placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."
)

# === –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï) ===
# –ú—ã —É—á–∏–º –±–æ—Ç–∞ –±—ã—Ç—å –º–µ—Ç–æ–¥–∏—Å—Ç–æ–º, —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥.
SYSTEM_PROMPT = """
–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –°—Ä–µ—Ç–µ–Ω—Å–∫–æ–π –¥—É—Ö–æ–≤–Ω–æ–π –∞–∫–∞–¥–µ–º–∏–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º, –æ—Ç–≤–µ—á–∞—è –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å—Ç—Ä–æ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ç–æ–≤.

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ö–û–ù–¢–ï–ö–°–¢. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ –Ω–∏–∂–µ, —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –£—á–µ–±–Ω—É—é —á–∞—Å—Ç—å".
2. –¶–ò–¢–ò–†–£–ô –ò–°–¢–û–ß–ù–ò–ö–ò. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –ø—É–Ω–∫—Ç/—Å—Ç–∞—Ç—å—é. 
   –ü—Ä–∏–º–µ—Ä: "–°–æ–≥–ª–∞—Å–Ω–æ –ü–æ–ª–æ–∂–µ–Ω–∏—é –æ —Å—Ç–∏–ø–µ–Ω–¥–∏—è—Ö (–ø. 2.3)..."
3. –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
   - –ö—Ä–∞—Ç–∫–∏–π –ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç.
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏.
   - (–ï—Å–ª–∏ –Ω—É–∂–Ω–æ) –°–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞.
4. –í–ï–î–ò –î–ò–ê–õ–û–ì. –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–æ–∂–∏ 2-3 –≤–æ–∑–º–æ–∂–Ω—ã—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–≥–∏—á–Ω–æ –≤—ã—Ç–µ–∫–∞—é—Ç –∏–∑ —Ç–µ–º—ã.
   –§–æ—Ä–º–∞—Ç: "–í–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–æ —É–∑–Ω–∞—Ç—å: [–í–æ–ø—Ä–æ—Å 1], [–í–æ–ø—Ä–æ—Å 2]".

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π, –Ω–æ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π. –¢—ã –æ–±—â–∞–µ—à—å—Å—è –≤ –¥—É—Ö–æ–≤–Ω–æ–º —É—á–µ–±–Ω–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏.
"""

async def get_rag_response(question: str):
    """–§—É–Ω–∫—Ü–∏—è –æ–±—â–µ–Ω–∏—è —Å –º–æ–∑–≥–æ–º"""
    try:
        # 1. –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ (–±–µ—Ä–µ–º 6 —Å–∞–º—ã—Ö –ø–æ—Ö–æ–∂–∏—Ö –∫—É—Å–æ—á–∫–æ–≤)
        docs = db.similarity_search(question, k=6)
        
        if not docs:
            return "üòî –í –º–æ–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞—à–ª–æ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å."

        # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
        context_text = ""
        sources_list = set() # –ß—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        
        for i, d in enumerate(docs):
            source_name = d.metadata.get('source', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç')
            # –û—á–∏—â–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è
            source_name = os.path.basename(source_name)
            sources_list.add(source_name)
            
            context_text += f"--- –§–†–ê–ì–ú–ï–ù–¢ {i+1} –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ '{source_name}' ---\n{d.page_content}\n\n"

        # 3. –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LLM
        messages = [
            ("system", SYSTEM_PROMPT),
            ("human", f"–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –î–û–ö–£–ú–ï–ù–¢–û–í:\n{context_text}\n\n–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {question}")
        ]

        # 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        ai_response = await llm.ainvoke(messages)
        answer = ai_response.content
        
        # 5. –ö—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤–Ω–∏–∑—É (–¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
        sources_formatted = "\n".join([f"üìÑ {s}" for s in sources_list])
        final_answer = f"{answer}\n\n___\nüîç *–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:*\n{sources_formatted}"
        
        return final_answer

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

# === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–û–ë–©–ï–ù–ò–ô ===

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer(
        f"üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {message.from_user.first_name}!\n\n"
        "–Ø ‚Äî –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –°—Ä–µ—Ç–µ–Ω—Å–∫–æ–π –¥—É—Ö–æ–≤–Ω–æ–π –∞–∫–∞–¥–µ–º–∏–∏.\n"
        "–Ø –∑–Ω–∞—é –≤—Å—ë –æ –ü–æ–ª–æ–∂–µ–Ω–∏—è—Ö, –ü—Ä–∏–∫–∞–∑–∞—Ö –∏ –£—Å—Ç–∞–≤–µ –ê–∫–∞–¥–µ–º–∏–∏.\n\n"
        "üìñ **–ß–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å?**\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É –≤ –º–µ–Ω—é –Ω–∏–∂–µ.",
        reply_markup=kb_main,
        parse_mode=ParseMode.MARKDOWN
    )

@dp.message()
async def handle_text_message(message: types.Message):
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç"
    await bot.send_chat_action(chat_id=message.chat.id, action="typing")
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç RAG
    response = await get_rag_response(message.text)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Markdown –∑–≤–µ–∑–¥–æ—á–∫–∏ –∏ —Ç.–¥.)
    try:
        await message.answer(response, parse_mode=ParseMode.MARKDOWN)
    except:
        # –ï—Å–ª–∏ Markdown —Å–ª–æ–º–∞–ª—Å—è (–±—ã–≤–∞–µ—Ç —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç
        await message.answer(response)

# === –ó–ê–ü–£–°–ö ===
async def main():
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –∂–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
